# =============================================================================
# Docker Compose – Laravel 11 / PHP 8.2+ / MySQL 8 / Redis 7 Alpine
# Ambiente: desenvolvimento local
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # APP – PHP-FPM (imagem customizada)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      target: local                     # multi-stage: usa o stage "local"
    container_name: ${APP_NAME:-laravel}_app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html                 # bind-mount do código-fonte
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/99-custom.ini:ro
      - ./docker/php/www.conf:/usr/local/etc/php-fpm.d/www.conf:ro
    environment:
      APP_ENV:   ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - laravel_net

  # ---------------------------------------------------------------------------
  # MYSQL 8
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: ${APP_NAME:-laravel}_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:?DB_ROOT_PASSWORD is required}
      MYSQL_DATABASE:      ${DB_DATABASE:-laravel}
      MYSQL_USER:          ${DB_USERNAME:-laravel}
      MYSQL_PASSWORD:      ${DB_PASSWORD:?DB_PASSWORD is required}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/99-custom.cnf:ro
    ports:
      - "${DB_EXTERNAL_PORT:-3306}:3306"  # exposto apenas para ferramentas locais (Tableplus, DBeaver)
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-p${DB_ROOT_PASSWORD:?}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - laravel_net

  # ---------------------------------------------------------------------------
  # REDIS 7 Alpine – cache + idempotência
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: ${APP_NAME:-laravel}_redis
    restart: unless-stopped
    command: >
      redis-server
        --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
        --maxmemory 256mb
        --maxmemory-policy allkeys-lru
        --save 60 1
        --loglevel warning
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:?}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - laravel_net

# =============================================================================
# Redes
# =============================================================================
networks:
  laravel_net:
    driver: bridge

# =============================================================================
# Volumes nomeados (persistência)
# =============================================================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
