{
    "openapi": "3.0.0",
    "info": {
        "title": "PHP Teste — API de Propostas",
        "description": "API REST para gestão de clientes, propostas financeiras e pedidos. Implementa máquina de estados, optimistic locking, idempotência e auditoria automática.",
        "contact": {
            "name": "Higor Moreira",
            "email": "higor@example.com"
        },
        "version": "1.0.0"
    },
    "servers": [
        {
            "url": "/",
            "description": "API v1"
        }
    ],
    "paths": {
        "/api/v1/clientes": {
            "post": {
                "tags": [
                    "Clientes"
                ],
                "summary": "Cria um novo cliente",
                "operationId": "d82cb60437b288da7843df7826fad22f",
                "parameters": [
                    {
                        "name": "Idempotency-Key",
                        "in": "header",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "nome",
                                    "email",
                                    "documento"
                                ],
                                "properties": {
                                    "nome": {
                                        "type": "string",
                                        "example": "João Silva"
                                    },
                                    "email": {
                                        "type": "string",
                                        "format": "email",
                                        "example": "joao@example.com"
                                    },
                                    "documento": {
                                        "type": "string",
                                        "example": "123.456.789-09"
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Cliente criado",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ClienteResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Dados inválidos"
                    }
                }
            }
        },
        "/api/v1/clientes/{cliente}": {
            "get": {
                "tags": [
                    "Clientes"
                ],
                "summary": "Exibe um cliente",
                "operationId": "ab4ce3009d7508c93f86a31ca7afca31",
                "parameters": [
                    {
                        "name": "cliente",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Dados do cliente",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ClienteResource"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Cliente não encontrado"
                    }
                }
            }
        },
        "/api/v1/orders": {
            "get": {
                "tags": [
                    "Orders"
                ],
                "summary": "Lista pedidos paginados",
                "operationId": "00d3856d2d3d93124e0cc021d0cb5b79",
                "parameters": [
                    {
                        "name": "status",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "per_page",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "default": 15
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Lista paginada de pedidos"
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}/orders": {
            "post": {
                "tags": [
                    "Orders"
                ],
                "summary": "Cria um pedido a partir de uma proposta aprovada",
                "operationId": "6d037f518a3c5bc3c6b56ff85e4d4baf",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "requestBody": {
                    "required": false,
                    "content": {
                        "application/json": {
                            "schema": {
                                "properties": {
                                    "observacoes": {
                                        "type": "string",
                                        "example": "Entrega urgente",
                                        "nullable": true
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Pedido criado",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/OrderResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Proposta nao aprovada ou ja possui pedido ativo"
                    }
                }
            }
        },
        "/api/v1/orders/{order}": {
            "get": {
                "tags": [
                    "Orders"
                ],
                "summary": "Exibe um pedido",
                "operationId": "38713af501dbd66af5a66bd568a49bc2",
                "parameters": [
                    {
                        "name": "order",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Dados do pedido",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/OrderResource"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Pedido nao encontrado"
                    }
                }
            }
        },
        "/api/v1/orders/{order}/cancel": {
            "post": {
                "tags": [
                    "Orders"
                ],
                "summary": "Cancela um pedido",
                "operationId": "aee443a742a80c8c038743d02cee6c66",
                "parameters": [
                    {
                        "name": "order",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Pedido cancelado",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/OrderResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Pedido nao pode ser cancelado no status atual"
                    }
                }
            }
        },
        "/api/v1/propostas": {
            "get": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Lista propostas com filtros e paginação",
                "operationId": "314cc051691e9bfac937d70db67f723f",
                "parameters": [
                    {
                        "name": "status",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "draft",
                                "submitted",
                                "approved",
                                "rejected",
                                "canceled"
                            ]
                        }
                    },
                    {
                        "name": "cliente_id",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer"
                        }
                    },
                    {
                        "name": "sort",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "default": "created_at"
                        }
                    },
                    {
                        "name": "direction",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "default": "desc",
                            "enum": [
                                "asc",
                                "desc"
                            ]
                        }
                    },
                    {
                        "name": "per_page",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "default": 15
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Lista paginada de propostas"
                    }
                }
            },
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Cria uma nova proposta (status inicial: DRAFT)",
                "operationId": "67a75e44bb7afd71d9e6f32a66e57d12",
                "parameters": [
                    {
                        "name": "Idempotency-Key",
                        "in": "header",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "cliente_id",
                                    "produto",
                                    "valor_mensal",
                                    "origem"
                                ],
                                "properties": {
                                    "cliente_id": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "produto": {
                                        "type": "string",
                                        "example": "Crédito Pessoal"
                                    },
                                    "valor_mensal": {
                                        "type": "number",
                                        "format": "float",
                                        "example": 1200
                                    },
                                    "origem": {
                                        "type": "string",
                                        "enum": [
                                            "app",
                                            "site",
                                            "api"
                                        ],
                                        "example": "api"
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Proposta criada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Dados inválidos"
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}": {
            "get": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Exibe uma proposta",
                "operationId": "3fd18c6e325de0d3530dc26591e3f716",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Dados da proposta",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Não encontrada"
                    }
                }
            },
            "patch": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Atualiza campos livres com Optimistic Lock",
                "operationId": "fe05489fc32c1e1a39c97968ef95da91",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "versao"
                                ],
                                "properties": {
                                    "versao": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "produto": {
                                        "type": "string",
                                        "example": "Empréstimo"
                                    },
                                    "valor_mensal": {
                                        "type": "number",
                                        "example": 999.99
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Proposta atualizada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "409": {
                        "description": "Conflito de versão",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorConcurrency"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Estado terminal",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorBusiness"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}/submit": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "DRAFT → SUBMITTED",
                "operationId": "f76004f47bcc94df7e4d29761870e247",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta submetida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorBusiness"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}/approve": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "SUBMITTED → APPROVED",
                "operationId": "337553da2196ccbec159014ab29067e9",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta aprovada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorBusiness"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}/reject": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "SUBMITTED → REJECTED",
                "operationId": "65e051a47abc68aaddfe59ba93a0aa3a",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta rejeitada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorBusiness"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}/cancel": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "DRAFT|SUBMITTED → CANCELED",
                "operationId": "911bae092766b19ffcabaa6d23d90e08",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta cancelada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/PropostaResource"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorBusiness"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/propostas/{proposta}/auditoria": {
            "get": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Histórico de auditoria da proposta",
                "operationId": "6514d3da140e6e21e353b43c84f0dec5",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Histórico de auditoria",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "$ref": "#/components/schemas/AuditoriaResource"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    },
    "components": {
        "schemas": {
            "ClienteResource": {
                "properties": {
                    "id": {
                        "description": "Controlador vazio que serve de âncora para as anotações globais do Swagger.",
                        "type": "integer",
                        "example": 1
                    },
                    "nome": {
                        "type": "string",
                        "example": "João Silva"
                    },
                    "email": {
                        "type": "string",
                        "format": "email",
                        "example": "joao@example.com"
                    },
                    "documento": {
                        "type": "string",
                        "example": "123.456.789-09"
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "PropostaResource": {
                "properties": {
                    "id": {
                        "type": "integer",
                        "example": 1
                    },
                    "cliente_id": {
                        "type": "integer",
                        "example": 1
                    },
                    "produto": {
                        "type": "string",
                        "example": "Crédito Pessoal"
                    },
                    "valor_mensal": {
                        "type": "number",
                        "format": "float",
                        "example": 1200
                    },
                    "status": {
                        "type": "string",
                        "enum": [
                            "draft",
                            "submitted",
                            "approved",
                            "rejected",
                            "canceled"
                        ],
                        "example": "draft"
                    },
                    "origem": {
                        "type": "string",
                        "enum": [
                            "app",
                            "site",
                            "api"
                        ],
                        "example": "api"
                    },
                    "versao": {
                        "type": "integer",
                        "example": 1
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "OrderResource": {
                "properties": {
                    "id": {
                        "type": "integer",
                        "example": 1
                    },
                    "proposta_id": {
                        "type": "integer",
                        "example": 1
                    },
                    "status": {
                        "type": "string",
                        "enum": [
                            "pending",
                            "approved",
                            "rejected",
                            "shipped",
                            "delivered",
                            "cancelled"
                        ],
                        "example": "pending"
                    },
                    "status_label": {
                        "type": "string",
                        "example": "Aguardando pagamento"
                    },
                    "valor_total": {
                        "type": "number",
                        "format": "float",
                        "example": 1200
                    },
                    "observacoes": {
                        "type": "string",
                        "nullable": true
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "AuditoriaResource": {
                "properties": {
                    "actor": {
                        "type": "string",
                        "example": "user:1"
                    },
                    "evento": {
                        "type": "string",
                        "enum": [
                            "created",
                            "updated_fields",
                            "status_changed",
                            "deleted_logical"
                        ]
                    },
                    "payload": {
                        "type": "object"
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "ErrorBusiness": {
                "properties": {
                    "error": {
                        "type": "string",
                        "example": "Unprocessable Entity"
                    },
                    "message": {
                        "type": "string",
                        "example": "Transição de status inválida."
                    }
                },
                "type": "object"
            },
            "ErrorConcurrency": {
                "properties": {
                    "error": {
                        "type": "string",
                        "example": "Conflict"
                    },
                    "message": {
                        "type": "string",
                        "example": "A versão enviada está desatualizada."
                    }
                },
                "type": "object"
            }
        }
    },
    "tags": [
        {
            "name": "Clientes",
            "description": "Gestão de clientes"
        },
        {
            "name": "Orders",
            "description": "Gestao de pedidos gerados a partir de propostas aprovadas"
        },
        {
            "name": "Propostas",
            "description": "Gestão de propostas com máquina de estados, optimistic lock e auditoria"
        }
    ]
}